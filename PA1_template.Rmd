---
title: "Reproducible Research: Peer Assessment 1"
output: 
  html_document:
    keep_md: true
---

[repdate-012](https://www.coursera.org/course/repdata) /
[Dmitry B. Grekov](mailto:dmitry.grekov@gmail.com) /
`r Sys.Date()`


```{r pre_libs, echo=FALSE, results="hide"}
################################################################################
#
#  Hi classmate!
#
#  These blocks of commands are executed behind the curtain despite the 
#  explicit requirement to use echo=TRUE in the assignment instructions.  
#
#  Each block has its specific reason to be placed here, these reasons are
#  explained below. 
#
#  Please pay attention that the research remains reproducible as all the 
#  necessary code blocks remain in both .md and .html files.
#
#  And sorry in advance for my poor English.
#
################################################################################

# BLOCK #1
# Here we link the libraries suppressing all the startup and warning messages 
# produced by the packages. When we link them again below, they won't produce
# any undesirable output
suppressWarnings(
  {
  suppressPackageStartupMessages( 
      {
        library(dplyr)
        library(lubridate)
        library(ggplot2)
      }
    )
  }
)

# BLOCK #2
# Here we ensure that the 'actiity.csv' file exists in the working directory.
# As the instructions clearly state that this is not necessary, we also do it 
# behinf the curtain in order to allow the reader focusing on the research.
if (!file.exists("activity.csv")) {
  file.url <-"http://d396qusza40orc.cloudfront.net/repdata%2Fdata%2Factivity.zip"
  file.tmp <- tempfile(pattern="activity")
  file.res <- download.file(file.url, file.tmp, quiet=TRUE)
  file.csv <- unzip(file.tmp, overwrite=TRUE)
}
```



## Packages 
The following packages were used during this research and are required to reproduce it:  

```{r libs, echo=TRUE}
library(dplyr)      # a Grammar of data manipulation
library(lubridate)  # make dealing with dates a little easier
library(ggplot2)    # an implementation of the Grammar of Graphics
```

If some of these packages are missing, you have first to install them using <code>install.packages()</code> function.  


## Loading and preprocessing the data
The source data is stored int the `activity.csv` file in the working directory. If the file is missing by the time the script starts, it is donloaded from the WEB (this is done behind the curtain).  

### Initial data reading  
The raw data from the file is initially read into the `dt` variable:
```{r file.read}
dt <-read.csv("activity.csv", stringsAsFactors=FALSE)
```

As the data is read, our `dt` variable is a data.frame with the following three columns:

- `steps` - an integer containing the number of steps made during the interval
- `date` - the data of measurement in a character format (yyyy-mm-dd)
- `interval` - an integer value denoting the 5-minute interval for the measurement <small>(the value 5 denotes to 00:05, 115 to 01:15AM, 1325 to 1:25PM (13:25) and so on)</small>

### Data preprocessing

First, we convert the `date` into `POSIXct` format:
```{r convert_date}
dt <- mutate(dt, date = ymd(date))
```

Next, we transform the `interval` into 24-hour 'hh:mm' form in order to add visibility and facilitate sorting:
```{r convert_interval}
dt <- mutate(
        dt, 
        #step 1 - make it 'hhmm'
        interval = sprintf("%04d", interval),
        #step 2 - split hours and minutes with a colon
        interval = paste(substr(interval,1,2),substr(interval,3,4), sep=":")
      )
```

We also add new variables 

  - `hour` is the hour the interval belongs to, the format is `hh:00`
  - `day.type` is a factor to distinguish betweeb weekdays (1) and weekends (2)

```{r transform_hour_day.type}
dt <- mutate(
    dt,
    hour     =    paste(substr(interval,1,2),"00", sep=":"),
    day.type =    factor(
                      ifelse(wday(date) %in% 2:6, 1, 2), 
                      levels = c(1,2),
                      labels = c("weekday","weekend")
                    )
  )
```

So finally we have the following dataset:
```{r}
str(dt)
```

## What is mean total number of steps taken per day?
In order to answer this question we have to aggregate the data by date and calculate total number of steps per day. We will also exclude `NA` values during the transformation. The dataset for this question will be stored in the `dt.daily` variable: 

```{r q1_data}
dt.daily <- dt                     %>%
  na.omit()                        %>%
  group_by(date)                   %>%
  summarise(value=sum(steps))      
```

Now let's build a histogram for the daily totals. We will use ggplot plotting system:
```{r q1_hist, echo=TRUE, results='asis'}
# build the plot
g1 <- ggplot(dt.daily, aes(x=value)) 

# draw the histogram
g1 <- g1 + geom_histogram(binwidth=1000, fill="steelblue", color="white", alpha=9/13)

# X-axis adjustments
g1 <- g1 + xlab("Number of steps per day") 
g1 <- g1 + scale_x_continuous(breaks=seq(0,21000, by=1000), limits=c(0,21000)) 
g1 <- g1 + theme(axis.text.x = element_text(angle=60, hjust= 1))

# Y-axis adjustments
g1 <- g1 + ylab("Number of days")
g1 <- g1 + scale_y_continuous(breaks=0:30) 

g1 <- g1 + labs(list(title="Mean total number of steps per day"))

# draw the plot
print(g1)
```

The histogram shows that the mean total number of steps per day is about 10000-11000. If we calculate the value, we scan see that it is really so:
```{r q1_mean}
mean(dt.daily$value)
median(dt.daily$value)
```



## What is the average daily activity pattern?
In order to determine the daily activity pattern we have to group the data by a time interval and calculate mean numer of steps for each interval. As each interval contains 5 minutes, we can calculte per minute values by dividing the mean by 5. Really, per minute values make more sence. We will store the data in `dt.timely` variable:

```{r q2_data,results='asis'}
dt.timely <- dt                   %>%
  na.omit()                       %>%
  group_by(interval)              %>%
  summarise(value=mean(steps)/5)
```


Now we can buid a plot showing the daily activity pattern:
```{r q2_plot}
# construct the plot
g2 <- ggplot(dt.timely, aes(x=interval, y=value)) 

# draw a line
g2 <- g2 + geom_line(aes(group=1), color="steelblue", lwd=1) 

# adjust X-axis
g2 <- g2 + xlab("Time interval") 
g2 <- g2 + scale_x_discrete(breaks=unique(dt$hour)) 
g2 <- g2 + theme(axis.text.x = element_text(angle = 90, hjust = 1))

# Y-axis adjustments
g2 <- g2 + ylab("Mean number of steps per minute")

g2 <- g2 + labs(list(title="Average daily activity pattern"))

# draw the plot
print(g2)
```

## Imputing missing values



## Are there differences in activity patterns between weekdays and weekends?
